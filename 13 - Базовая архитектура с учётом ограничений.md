# 13. Базовая     архитектура с учётом ограничений бизнес-требований, НФТ, выбранной     архитектуры, адресация атрибутов качества

Ниже представлено **детальное описание базовой архитектуры** приложения с учётом:

1. **Ограничений бизнес-требований** (включая масштабируемость, социальные функции, стимулирование продаж и т.д.).
2. **Нефункциональных требований** (NFR) (производительность, безопасность, доступность, масштабируемость и т.д.).
3. **Выбранной архитектуры** (микросервисы, мультиоблако, гибридное хранилище, IoT Hub).
4. **Адресации (учёта) атрибутов качества** (Reliability, Availability, Performance, Security, Maintainability, Usability и др.).

## 1. Исходные условия и ключевые факторы

### 1.1. Бизнес-ограничения и цели

1. **Массовая аудитория по всему миру**
   - Приложение предназначено как для профессиональных спортсменов, так и для любителей (бег, йога, фитнес и пр.).
   - Важно поддерживать разные языки, социальные и геймификационные механики, а также устойчивую работу при скачкообразном росте пользователей (соревнования, челленджи).
2. **Интеграция с интернет-магазином**
   - Необходимо быстро направлять пользователей к покупкам товаров (обувь, одежда, аксессуары).
   - Прозрачная интеграция (желателен единый профиль/SSO), персональные рекомендации.
3. **Социальные функции и геймификация**
   - Формирование сообществ, групп по интересам, ленты активности, челленджи.
   - Механики вовлечения (ачивки, рейтинги, награды) как способ удержания пользователя.
4. **IoT-устройства и расширенная аналитика**
   - Возможность подключения фитнес-трекеров (Garmin, Polar, Apple Watch и т.д.).
   - Сбор метрик (пульс, расстояние, темп, кислород), их последующая обработка для рекомендаций.
5. **Защита данных и комплаенс**
   - Данные тренировок могут относиться к информации о здоровье пользователя, следовательно, нужно соблюдать GDPR и аналогичные требования в разных регионах.

### 1.2. Нефункциональные требования (NFR)

Ниже кратко перечислены самые важные:

1. **Производительность (Performance)**
   - Время отклика (latency) для ключевых операций (запуск/завершение тренировки, просмотр ленты) ≤ 1–2 сек (95-й перцентиль).
   - Поддержка десятков/сотен тысяч одновременных активных пользователей во время крупных челленджей.
2. **Доступность и отказоустойчивость (Availability / Reliability)**
   - SLA не менее 99,9% (для MVP) с возможностью увеличения до 99,95–99,99% в будущем.
   - Защита от сбоев (репликация данных, резервное копирование, механизм «горячего» переключения в другой регион).
3. **Масштабируемость (Scalability)**
   - Горизонтальное масштабирование сервисов в облачных средах.
   - Возможность быстро подключать новые регионы/провайдеров.
4. **Безопасность (Security)**
   - Шифрование (TLS) при передаче, защита PII (Personal Identifiable Information).
   - Соответствие требованиям GDPR/локальных законов, контроль доступов (OAuth2/OpenID Connect).
5. **Удобство сопровождения и поддержки (Maintainability / Supportability)**
   - Микросервисный подход, позволяющий развивать отдельные функции независимо.
   - CI/CD, централизованное логирование, мониторинг (Prometheus/Grafana, ELK/Splunk).
6. **Удобство использования (Usability)**
   - Плавная регистрация, интуитивный UI.
   - Лёгкая интеграция с соцсетями, фитнес-трекерами.

## 2. Базовая (целевая) архитектура

### 2.1. Общая схема (микросервисный подход)

Архитектура строится по **микросервисной** модели:

1. **Клиентский уровень (Client Layer)**
   - Мобильные приложения (iOS, Android), Web-портал, а также возможность SDK/интеграции для носимых устройств.
   - Ответственны за взаимодействие с пользователем, показ ленты, запуск/завершение тренировок, просмотр товаров.
2. **API Gateway**
   - Единая точка входа для всех клиентских запросов.
   - Функции аутентификации/авторизации (OAuth2, OpenID Connect), рейт-лимиты, кэширование.
   - Направляет запросы к нужным микросервисам.
3. **Набор микросервисов (Microservices Layer)**
   - **User Management (UMS)**: управление профилями, регистрация, авторизация (тесно связано с Auth-сервером).
   - **Workout & Activity (WAS)**: учёт тренировок (время, дистанция, пульс), хранение базовых метрик.
   - **Social & Group (SGS)**: лента активности, группы, комментарии, лайки.
   - **Gamification (GMS)**: челленджи, ачивки, рейтинги, награды.
   - **Inventory & Equipment (IES)**: данные об экипировке (пробег кроссовок, замена снаряжения).
   - **Promotions & News (PNS)**: управление рекламой, акциями, новостями спорта.
   - **Notifications (NFS)**: push, email, SMS-оповещения (вызов отправки через сторонние сервисы или собственные каналы).
   - **Analytics & Recommendations (ARS)**: персонализация (на основе ML), рекомендации по тренировкам и товарам.
   - (Опционально) **Order & Payment**: если часть e-commerce логики будет прямо внутри приложения (иначе — интеграция с внешним e-commerce).
4. **Интеграции и Data Layer**
   - **IoT Hub**: шлюз для фитнес-трекеров/смарт-часов, преобразование протоколов, первичная валидация данных.
   - **Data Storage**: гибридная схема (SQL + NoSQL + Time Series).
   - **Big Data & ML**: Data Lake (хранилище сырых данных), стриминг (Kafka/Flink), batch-аналитика (Spark), ML-модели (рекомендации, предиктивные анализы).
5. **Инфраструктурный слой (DevOps, Orchestration)**
   - **Kubernetes** для оркестрации контейнеров и горизонтального масштабирования.
   - **Terraform/Ansible** для управления инфраструктурой в мультиоблачной среде.
   - **CI/CD** (GitLab CI, Jenkins, GitHub Actions) для автоматической сборки, тестирования и деплоя сервисов.

### 2.2. Учет атрибутов качества

1. **Доступность (Availability)**
   - Горизонтальное масштабирование на уровне Kubernetes (реплики подов микросервисов).
   - Репликация баз данных (SQL и NoSQL) по разным зонам доступности.
   - Health-check’и и автоперезапуск (liveness/readiness) в Kubernetes.
2. **Производительность (Performance)**
   - Возможность кеширования (Redis) на уровне API Gateway и внутри сервисов (например, кэш рекомендаций).
   - Event-driven взаимодействие (Kafka) для асинхронных задач (логирование, обработка массива событий).
   - Использование gRPC (где нужно) для быстрых внутренних вызовов (межсервисная коммуникация).
3. **Масштабируемость (Scalability)**
   - Микросервисы легко тиражируются: если нагрузка растёт на Social & Group, то поднимаем больше реплик именно SGS.
   - Автоматический autoscaling на основе метрик (CPU, RAM, кол-во входящих запросов).
   - Возможность размещать кластеры в разных облаках (AWS, GCP, Azure) или регионах (US-East, EU-West, Asia).
4. **Безопасность (Security)**
   - Все внешние запросы идут через TLS/HTTPS, JWT-токены или OAuth2/OpenID Connect для авторизации.
   - Шифрование данных в покое (например, атрибуты пользователя, пароли) с помощью KMS (Key Management Service).
   - Ролевое разграничение доступа в приложении (администратор групп, модератор, обычный пользователь).
5. **Надёжность (Reliability)**
   - Разделение сервисов снижает риск единой точки отказа.
   - Circuit breaker, retry и fallback (например, через библиотеку Resilience4j) при межсервисном взаимодействии.
   - Регулярные бэкапы баз данных, журналирование транзакций.
6. **Удобство сопровождения (Maintainability)**
   - Единые принципы CI/CD, «инфраструктура как код» (Terraform), общий подход к логированию (ELK, Splunk) и мониторингу (Prometheus/Grafana).
   - Микросервисная модель упрощает локальную доработку сервисов (каждая команда имеет область ответственности).
7. **Удобство использования (Usability)**
   - Фокус на UX в мобильных и веб-приложениях: простая регистрация, понятная навигация по тренировкам и ленте, настраиваемые уведомления.
   - Мультиязычная поддержка (i18n), адаптивные интерфейсы.
   - Интеграция с соцсетями, чтобы делиться результатами (внешний шэринг).

### 2.3. Технологические решения в разрезе бизнес-требований

1. **Социальные функции и геймификация**
   - Реализованы как независимые микросервисы: Social & Group Service (SGS) и Gamification Service (GMS).
   - Они совместно используют NoSQL-хранилище (быстрый доступ к ленте, лайкам) и кэш (для лидербордов).
2. **Учёт тренировок**
   - Workout & Activity Service (WAS) обрабатывает данные о тренировках и синхронизируется с IoT Hub.
   - Хранение базовых данных (время, дистанция, тип тренировки) возможно в NoSQL, более детальные временные ряды (пульс, темп) — в Time Series DB.
3. **Интеграция с магазином**
   - Promotions & News Service (PNS) показывает персональные баннеры, ссылки на товары.
   - Inventory & Equipment Service (IES) анализирует износ обуви/снаряжения и триггерит рекламу (например, «Пора купить новые кроссовки»).
   - Логика заказов может быть во внешней e-commerce платформе (CRM/ERP), с которой микросервис (Order & Payment) интегрируется через API.
4. **Аналитика и рекомендации**
   - Analytics & Recommendations Service (ARS) обращается к Data Lake/ML Engine для генерации персональных планов тренировок, таргетированных акций.
   - Стриминговая обработка (Kafka/Flink) обеспечивает real-time обновления рейтингов, быстрые реакции на события (например, пользователь достиг 50 км пробежек за неделю — дать купон).
5. **Облачная стратегия**
   - Развёртывание в Kubernetes-кластерах разных облачных провайдеров (AWS EKS, Azure AKS, GCP GKE), либо в гибридном режиме.
   - Terraform для описания инфраструктуры, централизованный DevOps-подход.

## 3. Адресация бизнес-требований и ограничений

Ниже кратко описано, **как** конкретные элементы архитектуры закрывают ключевые бизнес-требования:

1. **Массовая аудитория, пики нагрузки**
   - Микросервисы + Kubernetes Autoscaling позволяют быстро масштабироваться.
   - NoSQL и Time Series DB обрабатывают высокую скорость записи (в момент массовых стартов тренировок).
2. **Фокус на продажах**
   - Inventory & Equipment Service + Promotions & News Service напрямую запускают персональные предложения.
   - Лёгкий переход в e-commerce (SSO) повышает конверсию.
3. **Социальные функции**
   - Отдельный Social & Group Service (SGS) поддерживает создание сообществ, публикации, чаты.
   - Gamification Service (GMS) стимулирует регулярные возвращения пользователей (повышенный retention).
4. **Сбор и анализ данных (Big Data, ML)**
   - Data Lake хранит сырые данные, где аналитики и ML-модели могут строить прогнозы спроса, персональные планы тренировок.
   - Streaming-движок (Kafka/Flink) даёт возможность мгновенно реагировать на события (уведомления, рейтинги).
5. **Безопасность и соответствие требованиям**
   - Использование централизованного Identity/Access Management (OAuth2, OpenID Connect).
   - Шифрование PII и фитнес-данных, учёт GDPR при работе с пользователями из ЕС (возможность «удалить все данные»).

## 4. Финальные замечания и эволюция архитектуры

- **Дальнейшая эволюция**:
  - Добавление новых сервисов (например, нутриционные подсказки, планирование питания) без изменения базовой структуры.
  - Углублённые AI-модели (прогноз перетренированности, рекомендации по восстановлению, интеграция с медицинскими партнёрами).
  - Расширенная AR/VR-функциональность (виртуальные состязания).
- **Риски**:
  - Сложность микросервисов и мультиоблачности (необходима дисциплина в CI/CD, мониторинге).
  - Дополнительные затраты на обученную команду DevOps/Data Engineers.
- **Преимущества**:
  - Высокая **гибкость**: можно легко добавлять новые возможности, сервисы, менять стеки БД под разные нужды.
  - Высокая **масштабируемость**: позволяет обрабатывать резкие всплески нагрузки.
  - Высокая **доступность**: распределённое развёртывание снижает единые точки отказа.

## Итог

**Базовая архитектура** приложения строится на **микросервисном** подходе с использованием **API Gateway**, **IoT Hub** для устройств, **гибридного хранилища** (SQL + NoSQL + Time Series) и **Big Data**-компонентов (Data Lake, Streaming, ML). Она **адресует** ключевые **бизнес-требования** (стимулирование продаж, социальные функции, глобальные челленджи, безопасность) и **нефункциональные требования** (производительность, масштабируемость, доступность, безопасность) за счёт распределённой отказоустойчивой инфраструктуры, гибких сервисов и проработанной схемы DevOps.

Данная архитектура готова к **поэтапному развитию**: начиная с MVP (базовые микросервисы) и заканчивая глобальным масштабированием и продвинутыми аналитическими возможностями (глубокие ML-модели, AR/VR, интеграции с партнёрами), сохраняя при этом **качество** и **устойчивость** в долгосрочной перспективе.
